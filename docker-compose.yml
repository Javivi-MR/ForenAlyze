version: '3.9'

services:
  postgres:
    image: postgres:16
    container_name: forenalyze-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-forenalyze} # Select your own username
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-forenalyze} # Select your own password
      POSTGRES_DB: ${POSTGRES_DB:-forenalyze}
    ports:
      - "5432:5432"
    volumes:
      - forenalyze_pgdata:/var/lib/postgresql/data

  tika:
    image: apache/tika:latest
    container_name: forenalyze-tika
    restart: unless-stopped
    ports:
      - "9998:9998"

  web:
    build: .
    container_name: forenalyze-web
    restart: unless-stopped
    depends_on:
      - postgres
      - tika
    env_file:
      - .env
    environment:
      # Si no se define DATABASE_URL en .env, se construye a partir de las
      # credenciales de Postgres anteriores (pensadas para desarrollo).
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg2://${POSTGRES_USER:-forenalyze}:${POSTGRES_PASSWORD:-forenalyze}@postgres:5432/${POSTGRES_DB:-forenalyze}}
      CLAMAV_PATH: ${CLAMAV_PATH:-clamscan}
      # SECRET_KEY debe venir de .env o del entorno; no se hardcodea aqu√≠.
      TIKA_ENABLED: ${TIKA_ENABLED:-"true"}
      TIKA_SERVER_URL: ${TIKA_SERVER_URL:-http://tika:9998}
    ports:
      - "8000:8000"

volumes:
  forenalyze_pgdata:
