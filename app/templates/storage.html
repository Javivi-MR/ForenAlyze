{% extends "base.html" %}

{% block title %}Storage · Forenalyze{% endblock %}

{% block subnav %}
<nav class="subnav">
  <div class="container-fluid">
    <ul class="nav">
      <li class="nav-item">
        <a class="nav-link" href="/dashboard">Dashboard</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/files">Files & analyses</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/logs">Logs</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/storage">Storage</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('dashboard.yara_rules_index') }}">YARA rules</a>
      </li>
      <li class="nav-item ms-auto">
        <a class="nav-link" href="/upload">Upload file</a>
      </li>
    </ul>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 py-lg-4 dashboard-page">
  <div class="row mb-3 align-items-center">
    <div class="col">
      <h1 class="h4 mb-0">Storage</h1>
      <p class="small text-muted mb-0">
        Overview of your personal storage usage and tools to free space when needed.
      </p>
    </div>
  </div>

  {# Avisos de estado de cuota #}
  {% if stats.status == 'full' %}
    <div class="alert alert-danger mb-3">
      <strong>Storage full.</strong>
      You have reached or exceeded your allocated storage ({{ stats.used_mb }} MB / {{ stats.quota_mb }} MB).
      Please delete files you no longer need before uploading new ones.
    </div>
  {% elif stats.status == 'warning' %}
    <div class="alert alert-warning mb-3">
      <strong>Storage nearly full.</strong>
      You are using {{ stats.used_mb }} MB out of {{ stats.quota_mb }} MB ({{ stats.used_pct }}%).
      Consider deleting older or large files to avoid interruptions.
    </div>
  {% elif stats.status == 'ok' %}
    <div class="alert alert-secondary mb-3 small mb-4">
      You are using {{ stats.used_mb }} MB out of {{ stats.quota_mb }} MB ({{ stats.used_pct }}%).
    </div>
  {% endif %}

  <div class="row g-3 mb-4">
    <div class="col-lg-4">
      <div class="card bg-dark text-light h-100">
        <div class="card-body">
          <div class="text-muted small mb-1">Current usage</div>
          <div class="d-flex justify-content-between align-items-baseline mb-2">
            <div class="fs-3 fw-semibold">
              {{ stats.used_mb }}<span class="fs-6 ms-1">MB</span>
            </div>
            <div class="text-muted small text-end">
              of {{ stats.quota_mb }} MB<br>
              ({{ stats.used_pct }}%)
            </div>
          </div>
          <div class="progress bg-secondary-subtle" style="height: 8px;">
            {% set bar_class = 'bg-success' %}
            {% if stats.status == 'warning' %}
              {% set bar_class = 'bg-warning text-dark' %}
            {% elif stats.status == 'full' %}
              {% set bar_class = 'bg-danger' %}
            {% endif %}
            <div
              class="progress-bar {{ bar_class }}"
              role="progressbar"
              style="width: {{ stats.used_pct }}%;"
              aria-valuenow="{{ stats.used_pct }}"
              aria-valuemin="0"
              aria-valuemax="100">
            </div>
          </div>
          <p class="small text-muted mt-3 mb-0">
            Remaining: {{ stats.remaining_mb }} MB.
          </p>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card bg-dark text-light h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="text-muted small">Tips</div>
          </div>
          <ul class="small mb-0 text-muted">
            <li>Delete large or obsolete files you no longer need.</li>
            <li>Keep only the most relevant analysis reports for your current work.</li>
            <li>When your storage is full, new uploads may be blocked until you free space.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="card bg-dark text-light">
    <div class="card-header border-0 d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Your files</span>
      <span class="small text-muted">
        Total: {{ files|length if files is defined else 0 }}
      </span>
    </div>
    <div class="table-responsive">
      <table class="table table-dark table-hover table-sm align-middle mb-0">
        <thead class="small text-uppercase text-muted">
          <tr>
            <th>Name</th>
            <th>Size</th>
            <th>Status</th>
            <th>Uploaded</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if files and files|length > 0 %}
            {% for f in files %}
            <tr>
              <td class="text-truncate" style="max-width: 260px;">
                {{ f.filename_original }}
              </td>
              <td class="small">
                {{ f.size_human }}
              </td>
              <td>
                {% set v = f.final_verdict %}
                <span class="badge
                  {% if v == 'clean' %} bg-success
                  {% elif v == 'suspicious' %} bg-warning text-dark
                  {% elif v == 'malicious' %} bg-danger
                  {% elif v == 'critical' %} bg-danger text-light
                  {% else %} bg-secondary{% endif %}">
                  {{ v or 'pending' }}
                </span>
              </td>
              <td class="small text-nowrap">
                {{ f.upload_date or '' }}
              </td>
              <td class="text-end">
                <form
                  method="post"
                  action="{{ url_for('dashboard.storage_delete_file', file_id=f.id) }}"
                  class="d-inline storage-delete-form"
                  data-file-name="{{ f.filename_original }}">
                  <button type="submit" class="btn btn-outline-danger btn-sm">
                    Delete
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                You have no files stored yet.<br>
                <a href="/upload" class="btn btn-primary btn-sm mt-3">Upload my first file</a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
 
<!-- Modal de confirmación para borrado en Storage -->
<div class="modal fade" id="storageDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border border-danger-subtle">
      <div class="modal-header border-0">
        <h5 class="modal-title">Delete file</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">
          You are about to permanently delete
          <span class="fw-semibold" data-role="file-name">this file</span>
          and all its associated analysis reports.
        </p>
        <p class="small text-muted mb-0">
          This action cannot be undone. Make sure you have exported or saved anything you still need.
        </p>
      </div>
      <div class="modal-footer border-0 d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-danger btn-sm" data-role="confirm-delete">
          Yes, delete permanently
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/storage.js') }}"></script>
{% endblock %}
