{% extends "base.html" %}

{% block title %}Files & analyses · ForenAlyze{% endblock %}

{% block subnav %}
<nav class="subnav">
  <div class="container-fluid">
    <ul class="nav">
      <li class="nav-item">
        <a class="nav-link" href="/dashboard">Dashboard</a>
      </li>
      <li class="nav-item">
  		<a class="nav-link active" href="/files">Files &amp; analyses</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/logs">Logs</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/storage">Storage</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{{ url_for('dashboard.yara_rules_index') }}">YARA rules</a>
      </li>
      <li class="nav-item ms-auto">
        <a class="nav-link" href="/upload">Upload file</a>
      </li>
    </ul>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 py-lg-4 dashboard-page">
  {% set tab = active_tab or 'files' %}
  <div class="row mb-3 align-items-center">
    <div class="col">
      <h1 class="h4 mb-0">Files & analyses</h1>
      <p class="small text-muted mb-0">
        Unified view of uploaded files and their completed analyses.
      </p>
    </div>
  </div>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <!-- Tabs for Files / Analyses -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link {% if tab == 'files' %}active{% endif %}" href="{{ url_for('dashboard.files', tab='files') }}">Files</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if tab == 'analyses' %}active{% endif %}" href="{{ url_for('dashboard.files', tab='analyses') }}">Analyses</a>
    </li>
  </ul>

  {% if tab == 'files' %}
  <div class="card bg-dark text-light">
    <div class="card-header border-0 d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Files list</span>
      <span class="small text-muted">
        Total: {{ files|length if files is defined else 0 }}
      </span>
    </div>
    <div class="table-responsive">
      <table class="table table-dark table-hover table-sm align-middle mb-0">
        <thead class="small text-uppercase text-muted">
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Size</th>
            <th>Status</th>
            <th>Uploaded</th>
            <th class="text-center">Info</th>
          </tr>
        </thead>
        <tbody>
          {% if files and files|length > 0 %}
            {% for f in files %}
            <tr>
              <td class="text-truncate" style="max-width: 240px;">
                {{ f.filename_original }}
              </td>
              <td class="small">
                {{ f.file_type or f.mime_type }}
              </td>
              <td class="small">
                {{ f.size_human }}
              </td>
              <td>
                {% set v = f.final_verdict %}
                <span class="badge
                  {% if v == 'clean' %} bg-success
                  {% elif v == 'suspicious' %} bg-warning text-dark
                  {% elif v == 'malicious' %} bg-danger
                  {% elif v == 'critical' %} bg-danger text-light
                  {% else %} bg-secondary{% endif %}">
                  {{ v or 'pending' }}
                </span>
              </td>
              <td class="small text-nowrap">
                {{ (f.upload_date|string)[:19] if f.upload_date else '' }}
              </td>
              <td class="text-center">
                <button
                  type="button"
                  class="btn btn-outline-secondary btn-sm file-meta-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#fileMetaModal"
                  data-filename="{{ f.filename_original }}"
                  data-meta='{{ {
                    "Nombre original": f.filename_original,
                    "Nombre almacenado": f.filename_stored,
                    "Tipo": f.file_type or f.mime_type,
                    "Tamaño": f.size_human,
                    "MIME": f.mime_type,
                    "SHA256": f.sha256,
                    "MD5": f.md5,
                    "SHA1": f.sha1,
                    "Veredicto": f.final_verdict,
                    "Usuario": f.user_username if f.user_username is defined else "N/D",
                    "Subido": (f.upload_date|string)[:19] if f.upload_date else '',
                    "Ruta almacenamiento": f.storage_path
                  } | tojson }}'
                >
                  ℹ
                </button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                There are no files uploaded yet.<br>
                <a href="/upload" class="btn btn-primary btn-sm mt-3">Upload my first file</a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  {% else %}
  <div class="card bg-dark text-light">
    <div class="card-header border-0 d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Analysis list</span>
      <span class="small text-muted">
        Total: {{ analyses|length if analyses is defined else 0 }}
      </span>
    </div>
    <div class="table-responsive">
      <table class="table table-dark table-hover table-sm align-middle mb-0" id="analysis-table">
        <thead class="small text-uppercase text-muted text-center">
          <tr>
            <th class="text-center">Date</th>
            <th>File</th>
            <th class="text-center">Type</th>
            <th class="text-center">Size</th>
            <th class="text-center">SHA256</th>
            <th class="text-center">Status</th>
            <th class="text-center">Detections</th>
            <th class="text-center">User</th>
            <th class="text-center">Report</th>
          </tr>
        </thead>
        <tbody>
          {% if analyses and analyses|length > 0 %}
            {% for a in analyses %}
            <tr>
              <td class="small text-nowrap text-center">
                {{ (a.analyzed_at|string)[:19] if a.analyzed_at else '' }}
              </td>
              <td class="text-truncate" style="max-width: 200px;">
                {{ a.filename_original }}
              </td>
              <td class="small text-center">
                {{ a.file_type or a.mime_type }}
              </td>
              <td class="small text-center">
                {{ a.size_human or '' }}
              </td>
              <td class="small font-monospace text-center" style="white-space: nowrap;">
                <span title="{{ a.sha256 or '' }}">{{ a.sha256 or '' }}</span>
              </td>
              <td class="text-center">
                {% set v = a.final_verdict %}
                <span class="badge
                  {% if v == 'clean' %} bg-success
                  {% elif v == 'suspicious' %} bg-warning text-dark
                  {% elif v == 'malicious' %} bg-danger
                  {% elif v == 'critical' %} bg-danger text-light
                  {% else %} bg-secondary{% endif %}">
                  {{ v or 'N/D' }}
                </span>
              </td>
              <td class="small text-center">
                {% if a.has_clamav %}
                  <span class="badge bg-secondary me-1">ClamAV</span>
                {% endif %}
                {% if a.has_yara %}
                  <span class="badge bg-info text-dark me-1">YARA</span>
                {% endif %}
                {% if a.macro_detected == 'yes' %}
                  <span class="badge bg-warning text-dark me-1">Macros</span>
                {% endif %}
                {% if a.stego_detected == 'possible' %}
                  <span class="badge bg-warning text-dark me-1">Stego</span>
                {% endif %}
                {% if a.has_audio %}
                  <span class="badge bg-primary me-1">Audio</span>
                {% endif %}
              </td>
              <td class="small text-center">
                {{ a.user_username }}
              </td>
              <td class="text-center">
                <a href="/analysis/{{ a.id }}/report" class="btn btn-outline-secondary btn-sm">View report</a>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                There are no analyses available yet.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Modal de metadatos -->
  <div class="modal fade" id="fileMetaModal" tabindex="-1" aria-labelledby="fileMetaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="fileMetaModalLabel">File metadata</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <dl class="row small mb-0" id="file-meta-content">
          </dl>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/files.js') }}"></script>
{% endblock %}
