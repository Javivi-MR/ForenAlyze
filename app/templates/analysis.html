{% extends "base.html" %}

{% block title %}Análisis · ForenHub{% endblock %}

{% block subnav %}
<nav class="subnav">
  <div class="container-fluid">
    <ul class="nav">
      <li class="nav-item">
        <a class="nav-link" href="/dashboard">Dashboard</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/files">Ficheros</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/analysis">Análisis</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/logs">Registros</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/storage">Almacenamiento</a>
      </li>
    </ul>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 py-lg-4 dashboard-page">
  <div class="row mb-3 align-items-center">
    <div class="col">
      <h1 class="h4 mb-0">Análisis realizados</h1>
      <p class="small text-muted mb-0">
        Histórico de análisis ejecutados sobre los ficheros subidos a ForenHub.
      </p>
    </div>
  </div>

  <div class="card bg-dark text-light">
    <div class="card-header border-0 d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Listado de análisis</span>
      <span class="small text-muted">
        Total: {{ analyses|length if analyses is defined else 0 }}
      </span>
    </div>
    <div class="table-responsive">
      <table class="table table-dark table-hover table-sm align-middle mb-0" id="analysis-table">
        <thead class="small text-uppercase text-muted">
          <tr>
            <th>Fecha</th>
            <th>Archivo</th>
            <th>Tipo</th>
            <th>Tamaño</th>
            <th>SHA256</th>
            <th>Estado</th>
            <th>Detecciones</th>
            <th>Usuario</th>
            <th class="text-end">Informe</th>
          </tr>
        </thead>
        <tbody>
          {% if analyses and analyses|length > 0 %}
            {% for a in analyses %}
            <tr>
              <td class="small text-nowrap">
                {{ a.analyzed_at or "" }}
              </td>
              <td class="text-truncate" style="max-width: 200px;">
                {{ a.filename_original }}
              </td>
              <td class="small">
                {{ a.file_type or a.mime_type }}
              </td>
              <td class="small">
                {{ a.size_human or "" }}
              </td>
              <td class="small text-truncate" style="max-width: 220px;">
                {{ a.sha256 or "" }}
              </td>
              <td>
                {% set v = a.final_verdict %}
                <span class="badge
                  {% if v == 'clean' %} bg-success
                  {% elif v == 'suspicious' %} bg-warning text-dark
                  {% elif v == 'malicious' %} bg-danger
                  {% elif v == 'critical' %} bg-danger text-light
                  {% else %} bg-secondary{% endif %}">
                  {{ v or 'N/D' }}
                </span>
              </td>
              <td class="small">
                {% if a.has_clamav %}
                  <span class="badge bg-secondary me-1">ClamAV</span>
                {% endif %}
                {% if a.has_yara %}
                  <span class="badge bg-info text-dark me-1">YARA</span>
                {% endif %}
                {% if a.macro_detected == 'yes' %}
                  <span class="badge bg-warning text-dark me-1">Macros</span>
                {% endif %}
                {% if a.stego_detected == 'possible' %}
                  <span class="badge bg-warning text-dark me-1">Estego</span>
                {% endif %}
                {% if a.has_audio %}
                  <span class="badge bg-primary me-1">Audio</span>
                {% endif %}
              </td>
              <td class="small">
                {{ a.user_username }}
              </td>
              <td class="text-end">
                <a href="/analysis/{{ a.id }}/report" class="btn btn-outline-secondary btn-sm">Ver informe</a>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                No hay análisis disponibles todavía.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Búsqueda rápida en el listado de análisis (por nombre de archivo o hash)
// Se puede ampliar en el futuro con filtros más avanzados.
</script>
{% endblock %}
